name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Create GitHub Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Generate changelog since last tag
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: SatyaAI ${{ github.ref_name }}
          body: |
            ## What's Changed
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ## Docker Images
            
            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            docker pull ghcr.io/${{ github.repository }}:latest
            ```
            
            ## Installation
            
            ### Docker Compose
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/docker-compose.yml
            docker-compose up -d
            ```
            
            ### Manual Installation
            ```bash
            wget https://github.com/${{ github.repository }}/archive/${{ github.ref_name }}.tar.gz
            tar -xzf ${{ github.ref_name }}.tar.gz
            cd satyaai-${{ github.ref_name }}
            npm install
            npm run build
            npm start
            ```
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}

  # Build and Test Release
  build-release:
    name: Build Release Assets
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Create Release Artifacts
  create-artifacts:
    name: Create Release Artifacts
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci

      - name: Build application
        run: |
          npm run build
          cd client && npm run build

      - name: Create source archive
        run: |
          tar -czf satyaai-${{ github.ref_name }}-source.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=uploads \
            --exclude=logs \
            --exclude=*.log \
            .

      - name: Create binary archive
        run: |
          mkdir -p release/satyaai-${{ github.ref_name }}
          cp -r dist/ release/satyaai-${{ github.ref_name }}/
          cp -r client/dist/ release/satyaai-${{ github.ref_name }}/public/
          cp package.json release/satyaai-${{ github.ref_name }}/
          cp README.md release/satyaai-${{ github.ref_name }}/
          cp LICENSE release/satyaai-${{ github.ref_name }}/ || true
          cp docker-compose.yml release/satyaai-${{ github.ref_name }}/
          cp ecosystem.config.js release/satyaai-${{ github.ref_name }}/
          cp -r scripts/ release/satyaai-${{ github.ref_name }}/
          
          cd release
          tar -czf satyaai-${{ github.ref_name }}-linux-x64.tar.gz satyaai-${{ github.ref_name }}/

      - name: Create installation script
        run: |
          cat > install.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "üöÄ Installing SatyaAI ${{ github.ref_name }}"
          
          # Check requirements
          command -v node >/dev/null 2>&1 || { echo "Node.js is required but not installed. Aborting." >&2; exit 1; }
          command -v python3 >/dev/null 2>&1 || { echo "Python 3 is required but not installed. Aborting." >&2; exit 1; }
          
          # Download and extract
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/satyaai-${{ github.ref_name }}-linux-x64.tar.gz
          tar -xzf satyaai-${{ github.ref_name }}-linux-x64.tar.gz
          cd satyaai-${{ github.ref_name }}
          
          # Install Python dependencies
          pip3 install -r requirements.txt
          
          # Setup environment
          cp .env.example .env
          
          echo "‚úÖ SatyaAI installed successfully!"
          echo "üìù Please edit .env file with your configuration"
          echo "üèÉ Run: npm start to start the application"
          EOF
          
          chmod +x install.sh

      - name: Upload source archive
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./satyaai-${{ github.ref_name }}-source.tar.gz
          asset_name: satyaai-${{ github.ref_name }}-source.tar.gz
          asset_content_type: application/gzip

      - name: Upload binary archive
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./release/satyaai-${{ github.ref_name }}-linux-x64.tar.gz
          asset_name: satyaai-${{ github.ref_name }}-linux-x64.tar.gz
          asset_content_type: application/gzip

      - name: Upload installation script
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./install.sh
          asset_name: install.sh
          asset_content_type: text/plain

      - name: Upload docker-compose.yml
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./docker-compose.yml
          asset_name: docker-compose.yml
          asset_content_type: text/yaml

  # Deploy to Production
  deploy-release:
    name: Deploy Release to Production
    runs-on: ubuntu-latest
    needs: [create-release, build-release]
    environment: production
    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/satyaai
            
            # Create backup
            ./scripts/deploy.sh backup
            
            # Pull new release
            docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            docker tag ghcr.io/${{ github.repository }}:${{ github.ref_name }} ghcr.io/${{ github.repository }}:latest
            
            # Deploy
            docker-compose pull
            docker-compose up -d
            
            # Health check
            sleep 30
            curl -f http://localhost:3000/api/health || exit 1
            curl -f http://localhost:5001/health || exit 1
            
            echo "‚úÖ Release ${{ github.ref_name }} deployed successfully!"

  # Update Documentation
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Update version in README
        run: |
          sed -i 's/Version: .*/Version: ${{ github.ref_name }}/' README.md
          sed -i 's/docker pull .*/docker pull ghcr.io\/${{ github.repository }}:${{ github.ref_name }}/' README.md

      - name: Commit version update
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Update version to ${{ github.ref_name }}" || exit 0
          git push

  # Notify Release
  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [deploy-release, update-docs]
    if: always()
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              channel: '#releases',
              username: 'Release Bot',
              icon_emoji: ':rocket:',
              attachments: [{
                color: 'good',
                title: 'SatyaAI ${{ github.ref_name }} Released! üéâ',
                fields: [{
                  title: 'Version',
                  value: '${{ github.ref_name }}',
                  short: true
                }, {
                  title: 'Status',
                  value: '${{ needs.deploy-release.result }}',
                  short: true
                }],
                actions: [{
                  type: 'button',
                  text: 'View Release',
                  url: 'https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}'
                }, {
                  type: 'button',
                  text: 'Download',
                  url: 'https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/satyaai-${{ github.ref_name }}-linux-x64.tar.gz'
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}